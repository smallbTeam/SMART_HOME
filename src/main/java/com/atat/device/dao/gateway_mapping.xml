<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.atat.device.dao.GatewayMapping">

    <insert id="addGateway" parameterType="java.util.Map">
        INSERT INTO Gateway
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="GatewayPort != null">
                GatewayPort,
            </if>
            <if test="IP != null and IP != ''">
                IP,
            </if>
            <if test="Address != null and Address != ''">
                Address,
            </if>
            <if test="Reserve != null and Reserve != ''">
                Reserve,
            </if>
            IsDeleted
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="GatewayPort != null">
                #{GatewayPort,jdbcType=INTEGER},
            </if>
            <if test="IP != null and IP != ''">
                #{IP},
            </if>
            <if test="Address != null and Address != ''">
                #{Address},
            </if>
            <if test="Reserve != null  and Reserve != ''">
                #{Reserve},
            </if>
            0
        </trim>
    </insert>

    <!--CREATE TABLE `Gateway` (-->
    <!--`id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT '网关ID',-->
    <!--`GatewayPort` tinyint(8) NOT NULL COMMENT '端口',-->
    <!--`IP` varchar(255) NOT NULL COMMENT '网关IP',-->
    <!--`Address` varchar(255) NOT NULL COMMENT '网关地址',-->
    <!--`CreatedDate` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',-->
    <!--`ModifiedDate` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '修改时间',-->
    <!--`IsDeleted` tinyint(4) NOT NULL DEFAULT '0' COMMENT '是否删除 1:是 2:否',-->
    <!--`Reserve` varchar(255) DEFAULT NULL COMMENT '预留字段',-->
    <!--PRIMARY KEY (`id`)-->
    <!--) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='网关表';-->

    <update id="updateGatewayByID" parameterType="java.util.Map">
        update Gateway
        <trim prefix="set" suffixOverrides=",">
            <if test="GatewayPort != null and GatewayPort !=''">
                GatewayPort= #{GatewayPort},
            </if>
            <if test="IP != null and IP !=''">
                IP= #{IP},
            </if>
            <if test="Address != null and Address !=''">
                Address= #{Address},
            </if>
            <if test="Reserve != null and Reserve !=''">
                Reserve= #{Reserve},
            </if>
            <if test="IsDeleted != null">
                IsDeleted=#{IsDeleted} ,
            </if>
            ModifiedDate = now()
        </trim>
        where id = #{GatewayId}
    </update>

    <select id="selectGatewayList" parameterType="java.util.Map"
            resultType="java.util.Map">
        select ga.id,  ga.GatewayPort, ga.IP, ga.Address,ga.CreatedDate,
        ga.ModifiedDate, ga.Reserve
        from Gateway ga
        LEFT JOIN CustomerGateway cg ON cg.GatewayId = ga.id
        LEFT JOIN Customer cu ON cu.id = cg.CustomerId
        WHERE
        ga.IsDeleted = 0 AND cg.IsDeleted = 0 AND cu.IsDeleted = 0
        <if test="GatewayPort  != null">
            and ga.GatewayPort = #{GatewayPort}
        </if>
        <if test="IP  != null and IP != ''">
            and ga.IP = #{IP}
        </if>
        <if test="Address  != null and Address != ''">
            and ga.Address = #{Address}
        </if>
        <if test="Reserve  != null and Reserve != ''">
            and ga.Reserve = #{Reserve}
        </if>
        <if test="CustomerId  != null">
            and cu.id = #{CustomerId}
        </if>
        <if test="gatewayId  != null">
            and ga.id = #{gatewayId}
        </if>

        ORDER BY ModifiedDate DESC
    </select>

    <!--CREATE TABLE `CustomerGateway` (-->
    <!--`id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT '设备ID',-->
    <!--`CustomerId` int(11) NOT NULL COMMENT '用户Id',-->
    <!--`GatewayId` int(11) NOT NULL COMMENT '网关ID',-->
    <!--`CreatedDate` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',-->
    <!--`ModifiedDate` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '修改时间',-->
    <!--`IsDeleted` tinyint(4) NOT NULL DEFAULT '0' COMMENT '是否删除 1:是 2:否',-->
    <!--`Reserve` varchar(255) DEFAULT NULL COMMENT '预留字段',-->
    <!--PRIMARY KEY (`id`)-->
    <!--) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='用户网关关系表';-->

    <insert id="addCustomerGatewayRel" parameterType="java.util.Map">
        INSERT INTO CustomerGateway
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="Reserve != null and Reserve != ''">
                Reserve,
            </if>
                GatewayId,
                CustomerId,
            IsDeleted
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="Reserve != null and Reserve != ''">
                #{Reserve},
            </if>
                #{GatewayId,jdbcType=INTEGER},
                #{CustomerId,jdbcType=INTEGER},
            0
        </trim>
    </insert>

    <update id="delCustomerGatewayRel" parameterType="java.util.Map">
        update CustomerGateway set  IsDeleted= 1 ,ModifiedDate = NOW()
        where
        GatewayId = #{GatewayId}
        and CustomerId = #{CustomerId}
    </update>

</mapper>
